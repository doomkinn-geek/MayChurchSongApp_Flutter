# Духовные песни: сборник текстов и мелодий

## Обзор функциональности

Приложение "Духовные песни" представляет собой удобный сборник духовных песен с возможностью поиска, добавления в избранное и автоматического обновления базы данных.

### Основные возможности

1. **Просмотр песен** - Легкий доступ ко всем песням в базе данных с удобной навигацией.
2. **Интеллектуальный поиск** - Мощная система поиска по номеру песни (с ведущими нулями или без них), заголовку и тексту.
3. **Избранные песни** - Возможность добавлять песни в избранное для быстрого доступа.
4. **Недавние песни** - Доступ к недавно просмотренным песням через отдельную вкладку.
5. **Автоматическое обновление** - Периодическое обновление базы данных из интернета.
6. **Настраиваемый интерфейс** - Выбор размера шрифта песен и интерфейса, а также темы оформления.
7. **Масштабирование текста** - Возможность изменять размер текста при просмотре песни.

### Переработанный интерфейс главного экрана

Интерфейс главного экрана был полностью переработан для улучшения пользовательского опыта:

1. **Встроенное поле поиска** - Добавлено поисковое поле в верхней части главного экрана для быстрого доступа к функции поиска.
2. **Отображение номеров песен** - Каждая песня в списке теперь отображается с номером, выделенным цветом для лучшей навигации.
3. **Алфавитная сортировка** - Песни автоматически сортируются по алфавиту для удобства просмотра.
4. **Информативный интерфейс** - Добавлена информация о количестве песен и результатах поиска.
5. **Оптимизированное отображение** - Улучшена плотность информации для максимальной эффективности использования экрана.

### Интеллектуальный поиск песен

Реализована продвинутая система поиска песен, которая значительно улучшает пользовательский опыт:

1. **Поиск по номеру без ведущих нулей** - Можно искать песню, вводя только значащие цифры (например, "39" вместо "0039").
2. **Приоритизация результатов** - Результаты сортируются по релевантности:
   - Высший приоритет: точное совпадение номера песни
   - Высокий приоритет: совпадение в начале заголовка
   - Средний приоритет: совпадение где-либо в заголовке
   - Низкий приоритет: совпадение в тексте песни

3. **Информативные сообщения о результатах** - Поиск показывает понятные сообщения о найденных песнях:
   - "Найдена песня с номером..." 
   - "Найдено песен по запросу..."
   - "Песни с номером... не найдено"

4. **Задержка при вводе** - Реализована задержка 300 мс для оптимизации производительности поиска.

### Навигация и доступ к песням

1. **Вкладка "Недавние"** - Заменена вкладка "Поиск" на вкладку "Недавние", где отображаются последние 10 просмотренных песен.
2. **Возврат к списку** - При просмотре песни нажатие на кнопку "Главная" возвращает к списку песен.
3. **Улучшенная организация** - Переработана логика навигации для более интуитивного использования.
4. **Сохранение недавних песен** - Список недавно просмотренных песен сохраняется между запусками приложения.

### Настройка размеров шрифта

Реализована гибкая система настройки размеров шрифта:

1. **Раздельные настройки размера шрифта**:
   - Отдельная настройка для текста песен
   - Отдельная настройка для элементов интерфейса
   
2. **Три варианта размера** для каждого типа:
   - Малый
   - Средний (по умолчанию)
   - Большой
   
3. **Оптимизированные размеры** - Шрифты уменьшены для более компактного и эффективного использования пространства экрана:
   - Шрифты песен уменьшены на 25%
   - Шрифты интерфейса уменьшены на 33%
   
4. **Адаптивные межстрочные интервалы** - Автоматическая регулировка интервалов для лучшей читаемости.

### Возможности масштабирования текста

Реализована продвинутая система масштабирования текста в экране просмотра песни:

1. **Жесты масштабирования** - Изменение размера текста с помощью жеста "щипка" (pinch-to-zoom).
2. **Кнопки масштабирования** - Наличие кнопок увеличения и уменьшения размера текста.
3. **Индикатор масштаба** - Отображение текущего масштаба в процентах.
4. **Оптимизированная прокрутка** - Полнофункциональная прокрутка текста при любом масштабе.
5. **Сохранение пропорций** - Автоматическое масштабирование межстрочных интервалов для лучшей читаемости.

### Периодическое обновление базы данных

Реализована продвинутая система обновления базы данных песен из интернета. Приложение может периодически проверять наличие новых песен на сайте и добавлять их в локальную базу данных.

#### Ключевые компоненты:

1. **Интеллектуальный парсер** - `SongUpdater` анализирует HTML-структуру песен и корректно форматирует текст, сохраняя структуру строф и строк.

2. **Worker для обновления** - `SongUpdateWorker` выполняет периодическое обновление базы данных, проверяет наличие новых песен и добавляет их в базу данных.

3. **Управление расписанием** - `WorkManagerHelper` позволяет настраивать расписание обновлений, запускать и отменять задачи.

4. **Настройки пользователя** - Добавлены настройки, позволяющие пользователю контролировать:
   - Включение/отключение автоматических обновлений
   - Интервал обновления (12 часов, 24 часа, 48 часов, неделя)
   - Возможность запустить обновление вручную или проверить наличие новых песен

5. **Отслеживание и отображение времени обновления** - В приложении отображается время последнего обновления базы данных.

### Интерактивный интерфейс обновления

1. **Расширенная информация об обновлениях** - Пользователь видит:
   - Дату и время последнего обновления
   - Количество новых песен, добавленных при обновлении
   - Количество обновленных существующих песен
   - Общее количество песен в базе данных

2. **Интерактивный процесс обновления** - В экране настроек добавлены возможности:
   - Проверить наличие новых песен (без обновления существующих)
   - Выполнить полное обновление всех песен
   - Визуальное отображение процесса обновления и его результатов

## Технические детали

### Используемые технологии:

- **Room Database** - для локального хранения данных песен
- **WorkManager** - для выполнения фоновых задач по расписанию
- **DataStore** - для хранения пользовательских настроек
- **Jetpack Compose** - для создания современного пользовательского интерфейса
- **Coroutines & Flow** - для асинхронной работы и реактивного программирования
- **Jsoup** - для парсинга HTML-контента
- **SQL** - продвинутые запросы с приоритизацией для интеллектуального поиска

### Ключевые компоненты приложения:

1. **База данных**
   - `SongDatabase` - Room база данных для хранения песен
   - `SongDao` - интерфейс для доступа к данным с продвинутыми методами поиска
   - `Song` - модель данных для песни

2. **Репозиторий и обновление**
   - `SongRepository` - репозиторий для доступа к данным из ViewModel
   - `SongUpdater` - утилита для обновления базы данных песен из интернета
   - `SongUpdateWorker` - Worker для периодического обновления в фоне
   - Интеллектуальная обработка песен с пропуском файлов оглавления (0000.html)

3. **Пользовательские настройки**
   - `UserPreferences` - класс для хранения настроек пользователя
   - `SettingsScreen` - экран настроек приложения

4. **Пользовательский интерфейс**
   - `HomeScreen` - главный экран приложения с интегрированным поиском и отображением песен
   - `RecentScreen` - экран недавно просмотренных песен 
   - `SongDetailScreen` - экран детальной информации о песне с масштабированием текста
   - `FavoritesScreen` - экран избранных песен
   - `SongItem` - компонент для отображения песни в списке с номером и заголовком

## Последние улучшения

### Улучшения интерфейса и настроек (март 2025)
1. **Раздельные настройки шрифтов** - Добавлена отдельная настройка для размера шрифта интерфейса и песен.
2. **Оптимизированные размеры шрифтов** - Шрифты уменьшены для более эффективного использования экрана:
   - Шрифты песен уменьшены на 25%
   - Шрифты интерфейса уменьшены на 33%
3. **Сохранение недавних песен** - Исправлена проблема с очисткой списка недавних песен при каждом запуске, теперь история сохраняется.

### Переработка интерфейса и навигации
1. **Интегрированный поиск** - Поисковое поле перенесено на главный экран для удобства использования.
2. **Интеллектуальный поиск** - Обновлена логика поиска для поддержки поиска по номеру без ведущих нулей.
3. **Вкладка недавних песен** - Заменена вкладка поиска на вкладку с недавно просмотренными песнями.
4. **Улучшенное отображение песен** - Добавлены номера песен в список для быстрого визуального поиска.

### Визуализация и пользовательский опыт
1. **Оптимизированные размеры шрифта** - Более компактные и читаемые размеры шрифта для всех элементов интерфейса.
2. **Улучшенное отображение песен** - Правильное форматирование строф и отступов.
3. **Плавная прокрутка** - Исправлены проблемы с прокруткой длинных текстов.
4. **Адаптивные межстрочные интервалы** - Автоматическая регулировка интервалов при изменении масштаба.

### Обработка данных
1. **Корректное распознавание песен** - Пропуск файлов оглавления (0000.html) при загрузке и обновлении.
2. **Улучшенный парсинг HTML** - Более точное извлечение и форматирование текстов песен.
3. **Оптимизация производительности** - Ускорение загрузки и обработки песен.

## Использование

### Поиск песен
1. На главном экране введите номер песни или текст для поиска в поисковое поле
2. Можно искать по:
   - Номеру песни (с ведущими нулями или без них, например, "39" или "0039")
   - Заголовку песни
   - Тексту песни
3. Результаты отображаются сразу и сортируются по релевантности

### Просмотр недавних песен
1. Нажмите на вкладку "Недавние" в нижней панели навигации
2. Просмотрите список недавно открытых песен (до 10 песен)
3. Нажмите на любую песню для просмотра

### Просмотр песен
1. Запустите приложение
2. На главном экране будет список всех доступных песен
3. Нажмите на песню, чтобы просмотреть её текст

### Масштабирование текста песни
1. Откройте песню
2. Для изменения масштаба используйте:
   - Жест "щипка" (pinch-to-zoom) для плавного изменения
   - Кнопки "+" и "-" в верхней панели для пошагового изменения
3. Текущий масштаб отображается в процентах внизу экрана

### Настройка размера шрифта
1. Перейдите в раздел "Настройки"
2. Вы можете отдельно настроить:
   - Размер шрифта песен (малый, средний, большой)
   - Размер шрифта интерфейса (малый, средний, большой)
3. Изменения применяются сразу после выбора

### Добавление песни в избранное
1. Откройте песню
2. Нажмите на иконку звездочки в верхнем правом углу
3. Песня будет добавлена в список избранных

### Настройка автоматических обновлений
1. Перейдите в раздел "Настройки"
2. В разделе "Обновление базы данных" настройте параметры автоматического обновления:
   - Включите/выключите автоматическое обновление
   - Выберите интервал обновления (12 часов, 24 часа, 48 часов, неделя)

### Ручное обновление базы данных
1. Перейдите в раздел "Настройки"
2. В разделе "Обновление базы данных" вы найдете две опции:
   - "Проверить наличие новых песен" - проверяет только наличие новых песен
   - "Принудительное обновление" - обновляет все песни (более длительная операция)
3. Нажмите соответствующую кнопку для запуска обновления
4. Дождитесь завершения процесса обновления и просмотрите результаты

## Архитектура

Приложение построено на основе архитектуры MVVM (Model-View-ViewModel):
- **Model**: Room база данных, Repository и модели данных
- **View**: Jetpack Compose UI компоненты (экраны, диалоги и т.д.)
- **ViewModel**: ViewModel классы для управления состоянием UI и бизнес-логики

Для взаимодействия между компонентами используются корутины и Flow для асинхронной обработки и реактивного программирования.

## Источник данных

Приложение использует данные с сайта [https://maychurch.ru/songs/](https://maychurch.ru/songs/), который содержит тексты духовных песен. 
